local TS = game:GetService("TweenService")
local PFS = game:GetService("PathfindingService")

local module = {}

local function getPos(obj)
	if obj:IsA("BasePart") then
		return obj.Position
	elseif obj:IsA("Model") and obj.PrimaryPart then
		return obj.PrimaryPart.Position
	end
end

local function applyGoal(obj, cf)
	if obj:IsA("BasePart") then
		return {CFrame = cf}
	elseif obj:IsA("Model") and obj.PrimaryPart then
		return {CFrame = cf}
	end
	return {}
end

local function calcTime(dist, minSp, maxSp)
	local sp = dist / 20
	if minSp and maxSp then
		sp = math.clamp(sp, minSp, maxSp)
	elseif minSp then
		sp = math.max(sp, minSp)
	elseif maxSp then
		sp = math.min(sp, maxSp)
	end
	return dist / sp
end

local function resolveTarget(dest)
	if typeof(dest) == "CFrame" then
		return dest.Position
	elseif typeof(dest) == "Vector3" then
		return dest
	elseif typeof(dest) == "Instance" then
		return dest.Position or (dest.PrimaryPart and dest.PrimaryPart.Position)
	end
end

function module.CTween(obj, destino, speedMin, speedMax, usePath)
	local originPos = getPos(obj)
	local target = resolveTarget(destino)
	if not originPos or not target then
		error("CTween: objeto ou destino inv√°lido")
	end

	if not usePath then
		local dist = (originPos - target).Magnitude
		local time = calcTime(dist, speedMin, maxSp)
		local info = TweenInfo.new(time, Enum.EasingStyle.Linear)
		local goal = applyGoal(obj, CFrame.new(target))
		return TS:Create(obj, info, goal)
	end

	local path = PFS:CreatePath({AgentCanJump = true})
	path:ComputeAsync(originPos, target)
	local points = path:GetWaypoints()

	if #points < 2 then
		local dist = (originPos - target).Magnitude
		local time = calcTime(dist, speedMin, speedMax)
		local info = TweenInfo.new(time, Enum.EasingStyle.Linear)
		local goal = applyGoal(obj, CFrame.new(target))
		return TS:Create(obj, info, goal)
	end

	local totalDist = 0
	for i = 1, #points - 1 do
		totalDist += (points[i + 1].Position - points[i].Position).Magnitude
	end

	local time = calcTime(totalDist, speedMin, speedMax)
	local info = TweenInfo.new(time, Enum.EasingStyle.Linear)
	local goal = applyGoal(obj, CFrame.new(points[#points].Position))
	return TS:Create(obj, info, goal)
end

return module
